<div class="container">
  <div class="customer login">
    <h1 id="recover" class="text-4xl" tabindex="-1">
      {{ 'customer.recover_password.title' | t }}
    </h1>
    <div>
      <p>
        {{ 'customer.recover_password.subtext' | t }}
      </p>

      {%- form 'recover_customer_password' -%}
        {% assign recover_success = form.posted_successfully? %}
        <div class="field">
          <input type="email"
            value=""
            name="email"
            id="RecoverEmail"
            autocorrect="off"
            autocapitalize="off"
            autocomplete="email"
            {% if form.errors %}
              aria-invalid="true"
              aria-describedby="RecoverEmail-email-error"
              autofocus
            {% endif %}
            placeholder="{{ 'customer.login_page.email' | t }}"
          >
          <label for="RecoverEmail">
            {{ 'customer.login_page.email' | t }}
          </label>
        </div>
        {%- if form.errors -%}
          <div class="p-4">
            <small id="RecoverEmail-email-error" class="form__message">
              <svg aria-hidden="true" focusable="false" role="presentation" viewBox="0 0 13 13">
                <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
                <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
                <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
                <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
              </svg>
              {{ form.errors.messages['form'] }}
            </small>
          </div>
        {%- endif -%}

        <div class="p-4">
          <button>
            {{ 'customer.login_page.submit' | t }}
          </button>
          <div class="flex justify-start mb-4">
            <span class="mr-2">Don't have an Account?</span>
            <a href="{{ routes.account_register_url }}">{{ 'customer.login_page.create_account' | t }}</a>
          </div>
          <a href="#login">
            {{ 'customer.login_page.cancel' | t }}
          </a>
        </div>
      {%- endform -%}
    </div>

    <h1 id="login" class="text-4xl max-w-xs mx-auto" tabindex="-1">
      {{ 'customer.login_page.title' | t }}
    </h1>
    <div>
      {%- if recover_success == true -%}
        <div class="p-4">
          <h3 class="form__message" tabindex="-1" autofocus>
            <svg aria-hidden="true" focusable="false" role="presentation" viewBox="0 0 13 13">
              <path d="M6.5 12.35C9.73087 12.35 12.35 9.73086 12.35 6.5C12.35 3.26913 9.73087 0.65 6.5 0.65C3.26913 0.65 0.65 3.26913 0.65 6.5C0.65 9.73086 3.26913 12.35 6.5 12.35Z" fill="#428445" stroke="white" stroke-width="0.7"/>
              <path d="M5.53271 8.66357L9.25213 4.68197" stroke="white"/>
              <path d="M4.10645 6.7688L6.13766 8.62553" stroke="white">
            </svg>
            {{ 'customer.recover_password.success' | t }}
          </h3>
        </div>
      {%- endif -%}
      {%- form 'customer_login', novalidate: 'novalidate' -%}
        {%- if form.errors -%}
          <div class="p-4">
            <h2 class="form__message" tabindex="-1" autofocus>
              <span class="visually-hidden">{{ 'accessibility.error' | t }} </span>
              <svg aria-hidden="true" focusable="false" role="presentation" viewBox="0 0 13 13">
                <circle cx="6.5" cy="6.50049" r="5.5" stroke="white" stroke-width="2"/>
                <circle cx="6.5" cy="6.5" r="5.5" fill="#EB001B" stroke="#EB001B" stroke-width="0.7"/>
                <path d="M5.87413 3.52832L5.97439 7.57216H7.02713L7.12739 3.52832H5.87413ZM6.50076 9.66091C6.88091 9.66091 7.18169 9.37267 7.18169 9.00504C7.18169 8.63742 6.88091 8.34917 6.50076 8.34917C6.12061 8.34917 5.81982 8.63742 5.81982 9.00504C5.81982 9.37267 6.12061 9.66091 6.50076 9.66091Z" fill="white"/>
                <path d="M5.87413 3.17832H5.51535L5.52424 3.537L5.6245 7.58083L5.63296 7.92216H5.97439H7.02713H7.36856L7.37702 7.58083L7.47728 3.537L7.48617 3.17832H7.12739H5.87413ZM6.50076 10.0109C7.06121 10.0109 7.5317 9.57872 7.5317 9.00504C7.5317 8.43137 7.06121 7.99918 6.50076 7.99918C5.94031 7.99918 5.46982 8.43137 5.46982 9.00504C5.46982 9.57872 5.94031 10.0109 6.50076 10.0109Z" fill="white" stroke="#EB001B" stroke-width="0.7">
              </svg>
              {{ 'templates.contact.form.error_heading' | t }}
            </h2>
            {{ form.errors | default_errors }}
          </div>
        {%- endif -%}

        <div class="field">        
          <input
            type="email"
            name="customer[email]"
            id="CustomerEmail"
            autocomplete="email"
            autocorrect="off"
            autocapitalize="off"
            {% if form.errors contains 'form' %}
              aria-invalid="true"
            {% endif %}
            placeholder="{{ 'customer.login_page.email' | t }}"
          >
          <label for="CustomerEmail">
            {{ 'customer.login_page.email' | t }}
          </label>
        </div>

        {%- if form.password_needed -%}
          <div class="field">
            <div class="relative w-full">
              <svg id="reveal__pw" class="cursor-pointer absolute right-2 top-1/2 transform -translate-y-1/2" width="22" height="14" viewBox="0 0 22 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M11 14C8.42746 14 5.80416 12.7966 3.36478 10.8265C1.59601 9.39795 0 7.57127 0 7C0 6.42873 1.59601 4.60205 3.36478 3.17352C5.80416 1.20337 8.42746 0 11 0C13.5725 0 16.1958 1.20337 18.6352 3.17352C20.404 4.60205 22 6.42873 22 7C22 7.57127 20.404 9.39795 18.6352 10.8265C16.1958 12.7966 13.5725 14 11 14ZM11 13C13.3054 13 15.7291 11.8882 18.0069 10.0485C18.8631 9.35702 19.6459 8.59992 20.2595 7.89758C20.5121 7.60849 20.7211 7.34482 20.8644 7.13802C20.9434 7.0241 21 6.91713 21 7C21 7.08287 20.9434 6.9759 20.8644 6.86198C20.7211 6.65518 20.5121 6.39151 20.2595 6.10242C19.6459 5.40008 18.8631 4.64298 18.0069 3.95148C15.7291 2.11183 13.3054 1 11 1C8.69464 1 6.27089 2.11183 3.99309 3.95148C3.1369 4.64298 2.35415 5.40008 1.7405 6.10242C1.48791 6.39151 1.27893 6.65518 1.13559 6.86198C1.05663 6.9759 1 7.08287 1 7C1 6.91713 1.05663 7.0241 1.13559 7.13802C1.27893 7.34482 1.48791 7.60849 1.7405 7.89758C2.35415 8.59992 3.1369 9.35702 3.99309 10.0485C6.27089 11.8882 8.69464 13 11 13ZM11 11C8.79086 11 7 9.20914 7 7C7 4.79086 8.79086 3 11 3C13.2091 3 15 4.79086 15 7C15 9.20914 13.2091 11 11 11ZM11 10C12.6569 10 14 8.65685 14 7C14 5.34315 12.6569 4 11 4C9.34315 4 8 5.34315 8 7C8 8.65685 9.34315 10 11 10Z" fill="#888888"/>
              </svg>
              <input
                type="password"
                value=""
                name="customer[password]"
                id="CustomerPassword"
                autocomplete="current-password"
                {% if form.errors contains 'form' %}
                  aria-invalid="true"
                {% endif %}
                placeholder="{{ 'customer.login_page.password' | t }}"
              >
            </div>
            <label for="CustomerPassword">
              {{ 'customer.login_page.password' | t }}
            </label>
          </div>

          <div class="flex justify-end p-4">
            <a href="#recover">
              {{ 'customer.login_page.forgot_password' | t }}
            </a>
          </div>
        {%- endif -%}

        <div class="p-4">
          <button onclick="fetchToken('CustomerEmail', 'CustomerPassword')">
            {{ 'customer.login_page.sign_in' | t }}
          </button>

          <div class="flex justify-start">
            <span class="mr-2">Don't have an Account?</span>
            <a href="{{ routes.account_register_url }}">{{ 'customer.login_page.create_account' | t }}</a>
          </div>
        </div>
      {%- endform -%}
    </div>
    
    {%- if shop.checkout.guest_login -%}
      <div>
        <hr>
        <h2>{{ 'customer.login_page.guest_title' | t }}</h2>

        {%- form 'guest_login' -%}
          <button>
            {{ 'customer.login_page.guest_continue' | t }}
          </button>
        {%- endform -%}
      </div>
    {%- endif -%}
  </div>
</div>

{% section 'newsletter' %}

<script>

  document.getElementById('reveal__pw').addEventListener('click', function () {
    var pwField = document.getElementById('CustomerPassword');
    if (pwField.type === 'password') {
      pwField.type = 'text';
    } else if (pwField.type === 'text') {
      pwField.type = 'password';
    }
  });

  function fetchToken(emailId, passwordId) {
    var email = document.getElementById(emailId).value;
    var password = document.getElementById(passwordId).value;
  
    const query = `mutation customerAccessTokenCreate($input: CustomerAccessTokenCreateInput!) {
      customerAccessTokenCreate(input: $input) {
        customerUserErrors {
          code
          field
          message
        }
        customerAccessToken {
          accessToken
          expiresAt
        }
      }
    }`;
    
    const xhr = new XMLHttpRequest();
    const url = window.location.origin + "/api/2021-07/graphql";
    xhr.open("POST", url);
    xhr.setRequestHeader("Accept", "application/json");
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.setRequestHeader("X-Shopify-Storefront-Access-Token", "f27e5b851c319cf71ac559d263b6fbaf");
  
    var requestBody = {
      query: query,
      variables: {
        input: {
          email: email,
          password: password
        }
      }
    };
    
    xhr.onreadystatechange = function() {
      if (this.readyState == 4) {
        var response = JSON.parse(this.responseText)?.data?.customerAccessTokenCreate;
        var errors = response?.customerUserErrors;
        if (errors.length != 0) {
          console.error(errors);
        } else {
          var accessToken = response?.customerAccessToken?.accessToken;
          var expirationDate = response?.customerAccessToken?.expiresAt;
          sessionStorage.setItem('accessToken', JSON.stringify({ token: accessToken, expiration: expirationDate }));
        }
      }
    };
    
    xhr.send(JSON.stringify(requestBody));
  }
</script>
